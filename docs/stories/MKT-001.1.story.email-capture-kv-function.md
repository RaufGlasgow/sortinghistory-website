# Story MKT-001.1: Email Capture KV and Function

## Summary
Create Cloudflare KV namespace and Pages Function to capture launch notification emails.

## Parent Epic
MKT-001: Website Email Capture System

## Dependencies
- None (first story in epic)

## Acceptance Criteria

### AC1: KV Namespace Created
- [ ] `LAUNCH_EMAILS` namespace exists in Cloudflare dashboard
- [ ] Namespace is bound to Pages project via `wrangler.toml`

### AC2: Subscribe Function Works
- [ ] `POST /api/subscribe` accepts `email` parameter
- [ ] Valid emails are stored in KV with metadata (timestamp, source)
- [ ] Invalid emails return 400 error with message
- [ ] Duplicate emails return 200 (idempotent, no error)
- [ ] Function returns JSON response

### AC3: Local Testing
- [ ] `wrangler pages dev` runs without errors
- [ ] Test submission stores in KV preview
- [ ] Verify stored data structure matches spec

## Technical Details

### File: `functions/api/subscribe.js`

```javascript
export async function onRequestPost(context) {
  const { request, env } = context;

  try {
    const formData = await request.formData();
    const email = formData.get('email')?.toLowerCase().trim();

    // Validate email
    if (!email || !isValidEmail(email)) {
      return new Response(JSON.stringify({
        success: false,
        error: 'Invalid email address'
      }), {
        status: 400,
        headers: { 'Content-Type': 'application/json' }
      });
    }

    // Store in KV
    const metadata = {
      email,
      timestamp: new Date().toISOString(),
      source: request.headers.get('Referer') || 'direct',
      userAgent: request.headers.get('User-Agent') || 'unknown'
    };

    await env.LAUNCH_EMAILS.put(email, JSON.stringify(metadata));

    return new Response(JSON.stringify({
      success: true,
      message: 'You\'ll be notified at launch!'
    }), {
      status: 200,
      headers: { 'Content-Type': 'application/json' }
    });

  } catch (error) {
    return new Response(JSON.stringify({
      success: false,
      error: 'Something went wrong. Please try again.'
    }), {
      status: 500,
      headers: { 'Content-Type': 'application/json' }
    });
  }
}

function isValidEmail(email) {
  const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return re.test(email);
}
```

### File: `wrangler.toml`

```toml
name = "sortinghistory-website"
compatibility_date = "2024-01-01"

[[kv_namespaces]]
binding = "LAUNCH_EMAILS"
id = "<KV_NAMESPACE_ID>"
preview_id = "<KV_PREVIEW_NAMESPACE_ID>"
```

## Setup Instructions (for developer)

### Step 1: Create KV Namespace
```bash
cd "/Users/raufglasgow/AI Projects/Trivia Game/SortingHistory-website/website"
wrangler kv:namespace create "LAUNCH_EMAILS"
wrangler kv:namespace create "LAUNCH_EMAILS" --preview
```

### Step 2: Copy IDs to wrangler.toml
Take the IDs from the output and add to wrangler.toml

### Step 3: Test locally
```bash
wrangler pages dev
# Open http://localhost:8788 and test form
```

## Out of Scope
- Email notification on signup (Story 1.3)
- Admin export endpoint (Story 1.3)
- Form UI feedback (Story 1.2)

## Estimate
30 minutes

## Definition of Done
- [ ] KV namespace created and bound
- [ ] Function deploys without errors
- [ ] Test email stored successfully
- [ ] PR merged to main
