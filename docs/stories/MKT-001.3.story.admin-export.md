# Story MKT-001.3: Admin Export Endpoint

## Summary
Create a password-protected endpoint to export all captured emails as CSV for launch announcement.

## Parent Epic
MKT-001: Website Email Capture System

## Dependencies
- MKT-001.1 (KV namespace must have data)

## Acceptance Criteria

### AC1: Export Endpoint Exists
- [ ] `GET /api/export-emails` endpoint exists
- [ ] Requires `key` query parameter matching secret
- [ ] Returns 401 if key is missing or wrong
- [ ] Returns CSV of all emails if key is correct

### AC2: CSV Format
- [ ] CSV includes columns: email, timestamp, source
- [ ] CSV has header row
- [ ] One email per row
- [ ] Properly escaped for email clients

### AC3: Secret Key Storage
- [ ] Secret key stored in Cloudflare environment variable
- [ ] Not hardcoded in source
- [ ] Documented how to set/change it

## Technical Details

### File: `functions/api/export-emails.js`

```javascript
export async function onRequestGet(context) {
  const { request, env } = context;

  // Check secret key
  const url = new URL(request.url);
  const key = url.searchParams.get('key');

  if (!key || key !== env.EXPORT_SECRET) {
    return new Response('Unauthorized', { status: 401 });
  }

  try {
    // List all keys in KV
    const list = await env.LAUNCH_EMAILS.list();
    const emails = [];

    for (const key of list.keys) {
      const value = await env.LAUNCH_EMAILS.get(key.name);
      if (value) {
        const data = JSON.parse(value);
        emails.push(data);
      }
    }

    // Generate CSV
    const csv = generateCSV(emails);

    return new Response(csv, {
      status: 200,
      headers: {
        'Content-Type': 'text/csv',
        'Content-Disposition': 'attachment; filename="launch-emails.csv"'
      }
    });

  } catch (error) {
    return new Response('Export failed: ' + error.message, { status: 500 });
  }
}

function generateCSV(emails) {
  const headers = ['email', 'timestamp', 'source'];
  const rows = emails.map(e => [
    escapeCSV(e.email),
    escapeCSV(e.timestamp),
    escapeCSV(e.source)
  ].join(','));

  return [headers.join(','), ...rows].join('\n');
}

function escapeCSV(value) {
  if (!value) return '';
  const str = String(value);
  if (str.includes(',') || str.includes('"') || str.includes('\n')) {
    return '"' + str.replace(/"/g, '""') + '"';
  }
  return str;
}
```

### Setting the Secret

```bash
# Set via Wrangler
wrangler pages secret put EXPORT_SECRET
# Enter a strong random string when prompted

# Or set in Cloudflare Dashboard:
# Pages > sortinghistory-website > Settings > Environment variables
```

### Usage

```bash
# Export all emails
curl "https://sortinghistory.com/api/export-emails?key=YOUR_SECRET" > emails.csv

# Open in Excel/Sheets and use for launch announcement
```

## Security Notes

1. Use a strong random secret (32+ characters)
2. Don't share the export URL publicly
3. Consider adding rate limiting if concerned about brute force
4. Rotate secret periodically

## Out of Scope
- Email sending (use exported CSV with Mailchimp/Buttondown/Gmail)
- Real-time notifications on signup
- Dashboard UI for viewing emails

## Estimate
15 minutes

## Definition of Done
- [ ] Export endpoint returns CSV
- [ ] Unauthorized requests rejected
- [ ] Secret stored as environment variable
- [ ] Tested with real data
- [ ] Export instructions documented
